# Auto-generated by agi-pack.
FROM {{ base }} AS {{ target }}

ENV PROJECT {{ name }}
ENV PYENV {{ name }}-{{ python_alias }}
ENV PYTHON_VERSION {{ python }}
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1
ENV PYTHONWARNINGS ignore

{% if env -%}
# Setup environment variables
{% for key, value in env.items() -%}
ENV {{ key }}={{ value }} {% endfor %}
{% endif %}

{%- if system %}
# Install system packages
RUN apt-get -y update \
    && apt-get -y install \
    curl git \
{%- for package in system %}
    {{ package }} \
{%- endfor %}
    && apt-get -y autoclean \
    && apt-get -y autoremove \
    && rm -rf /var/lib/apt/lists/*
{%- endif %}

# Setup conda paths
ENV CONDA_PATH=/opt/conda/envs/${PYENV}
ENV CONDA_PREFIX=${CONDA_PATH}
ENV CONDA_EXE=${CONDA_PATH}/bin/conda
ENV PATH=${CONDA_PATH}/bin:/opt/conda/bin:$PATH
ENV CONDA_DEFAULT_ENV ${PYENV}

# Install mambaforge
RUN curl -sLo ~/mambaforge.sh "https://github.com/conda-forge/miniforge/releases/latest/download/Mambaforge-$(uname)-$(uname -m).sh" \
  && chmod +x ~/mambaforge.sh \
  && ~/mambaforge.sh -b -p /opt/conda \
  && /opt/conda/bin/mamba init bash \
  && /opt/conda/bin/mamba config --set pip_interop_enabled True \
  && /opt/conda/bin/mamba create -n ${PYENV} python=${PYTHON_VERSION} -y \
  && rm ~/mambaforge.sh

{% if pip -%}
# Install pip packages, with cache mounting /opt/conda/pkgs for faster builds
# Note: Cache mounts allow us to re-use the cache for conda packages
# instead of having to re-download them every time we build.
RUN --mount=type=cache,target=/opt/conda/pkgs/ \
    mamba install -yv \
{%- for package in pip %}
    {{ package }} \
{%- endfor %}
{%- if prod %}
    && /opt/conda/bin/mamba clean -ya \
    && rm -rf ~/.cache/pip \
    && rm -rf /opt/conda/pkgs/* \
    && echo "pip install/cleanup complete"
{% else %}
    && echo "pip install complete"
{%- endif %}
{%- endif %}

{% if requirements -%}
# Install requirements, with cache mounting ~/.cache/pip for faster builds
# Note: Cache mounts allow us to re-use the cache for pip packages
# instead of having to re-download them every time we build.
{%- for package in requirements %}
COPY {{ package }} /tmp/reqs/{{ package }}
{%- endfor %}

RUN --mount=type=cache,target=~/.cache/pip \
    pip install --upgrade pip \
{%- for package in requirements %}
    && pip install -r /tmp/reqs/{{ package }} \
{%- endfor %}
{%- if prod %}
    && /opt/conda/bin/mamba clean -ya \
    && rm -rf ~/.cache/pip \
    && rm -rf /opt/conda/pkgs/* \
    && rm -r /tmp/reqs \
    && echo "pip cleanup complete"
{% else %}
{%- endif %}
    && echo "pip install complete"
{%- endif %}

# Export conda environment on login
RUN echo "export CONDA_PATH=/opt/conda/envs/${PYENV}" >> ~/.bashrc
RUN echo "export PATH=/opt/conda/envs/${PYENV}/bin:$PATH" >> ~/.bashrc
RUN echo "export CONDA_DEFAULT_ENV=${PYENV}" >> ~/.bashrc
RUN echo "mamba activate ${PYENV}" > ~/.bashrc

# Run commands
RUN \
{%- for cmd in run %}
    {{ cmd }} \
{%- endfor %}
    && echo "run commands complete"

FROM base AS dev
WORKDIR /app/$PROJECT-dev

FROM base AS prod
WORKDIR /app/$PROJECT-prod
ENTRYPOINT ["/bin/bash", "-c"]
